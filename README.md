Try to realize Alphanet

从前两节的回顾可以看出，CNN 和 RNN 是结合了特定领域知识构建出的神经网络，脱离
了其适用领域进行使用，效果可能会不达预期。具体对量化多因子选股而言，可能会有以
下问题：
1. 对于 CNN，卷积核的局部感知操作和数据的排布方式有关，然而股票因子数据没有固
定排布方式，这使得不同数据排布方式下的卷积效果会有差异。另外，卷积核运算的
本质是对卷积区域内的数据进行加权平均，这种运算方式可能难以有效提取股票数据
中的特征。
2. 对于 RNN，虽然其适用于序列特征提取，但递归运算的方式过于单一，可能难以有效
提取股票数据中较为复杂的特征。

**选股因子挖掘网络： Alphanet**
为了有效提取股票原始量价数据中的特征，AlphaNet 借鉴了遗传规划中特征构建的思想，将多种运算符函数作为
自定义网络层用于特征提取。AlphaNet 包含四部分：(1)数据输入：仿照 CNN 的方式，将
个股原始量价数据整理为二维“数据图片”的形式输入网络。(2)特征提取层：AlphaNet
中最关键的组成部分，实现了多种自定义运算网络层提取特征，并利用批标准化层(Batch 
Normalization)进行特征标准化。(3)池化层：与 CNN 中池化层基本一致，对上一层的特征
进行“模糊化”操作。(4)全连接层：对接预测目标，作用是对提取的特征进行加权合成。

**结构：** 

**数据输入**
AlphaNet 仿照 CNN 的方式，将个股量价数据整理为“数据图片”的形式输入网络。如图
表 6 所示，一只股票在 t-4 到 t 的量价数据构成一张“数据图片”，该个股对应一个收益率
R(t+m)作为标签。如果在一个时间截面上有 3000 只个股，我们就可以得到 3000 张个股的
“数据图片”及其对应的标签。值得注意的是，个股的量价数据不一定要按照图表 6 的方
式(open，high，low…)排布，可以按照任意的方式排布。

**特征提取层**
特征提取层是 AlphaNet 最关键的组成部分。AlphaNet 借鉴了遗传规划中特征构建的思想，
将多种运算符函数作为自定义网络层进行特征提取。 复杂且关键。

**BN 层**
BN(Batch Normalization)，中文为批标准化层，该层已经是目前神经网络中最常用的组件
之一，在 AlphaNet 的特征标准化中起着重要作用。

**池化层**
AlphaNet 的池化层机制和 CNN 基本一致，都是对上一层的特征进行“模糊化”操作。
ts_mean(X, d)对应 CNN 中的(1*d)mean_pooling，ts_max(X, d)对应 CNN 中的(1*d) 
max_pooling，ts_min(X, d)对应 CNN 中的(1*d) min_pooling。池化层也实现了运算符的
嵌套。

**全连接层**
在将特征提取层和池化层所得特征进行特征展平(flatten)后，会接入全连接层，全连接层
最后对接预测目标，整个网络的参数会根据预测目标的 loss 以反向传播的方式进行优化。
全连接层所起的作用是对特征进行加权合成，这与 CNN 中的全连接层一致。


**数据准备**
1. 股票池：全 A 股，剔除 ST、PT 股票，剔除每个截面期下一交易日涨跌停和停牌的股
票。
2. 原始数据：未经过特征工程的个股量价信息，如图表 12 所示。对于每只股票，将其
量价数据拼接成 9*30 的“数据图片”，30 为历史时间天数。
3. 预测目标：个股 10 天后标准化的收益率；个股 5 天后标准化的收益率。
4. 时间区间：2011 年 1 月 31 日至 2020 年 5 月 29 日。
5. 样本内数据大小：每次训练都使用过去 1500 个交易日的数据作为样本内数据，每隔
两天采样一次。
6. 训练集和验证集比例：按照时间先后进行 1：1 划分，训练集在前，验证集在后。

**AlphaNet-v1 训练和预测方式**
1. 模型训练：从 2011 年 1 月 31 日开始，每隔半年进行滚动训练。样本内数据为过去
1500 个交易日的数据，训练集和验证集按照 1：1 划分。
2. 模型预测：在每个样本外数据截面上，使用最新训练的模型预测个股未来 10 天/5 天
的收益率。
考虑到神经网络的训练受随机数种子影响较大，我们将以上步骤重复 10 次，得到 10 组预
测结果，对其进行综合分析。
组合构建和回测

对于 AlphaNet-v1 合成的因子，进行以下测试：
1. 单因子 IC 测试和分层测试。分析因子的 RankIC 均值、ICIR、分层组合年化收益率
等指标。
2. 构建行业市值中性的中证 500 增强策略进行回测。分析策略的年化超额收益率、信息
比率、超额收益最大回撤等指标。
