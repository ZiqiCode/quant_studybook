**尝试实现 AlphaNet**

回顾前两节内容，我们了解到CNN和RNN是基于特定领域知识构建的神经网络，如果脱离其适用领域使用，效果可能不尽如人意。对于量化多因子选股，可能会面临以下问题：

1. **CNN的问题：** 卷积核的局部感知操作和数据排布方式有关，而股票因子数据没有固定排布方式，这可能导致不同数据排布方式下的卷积效果有差异。此外，卷积核运算的本质是对卷积区域内的数据进行加权平均，这种运算方式可能难以有效提取股票数据中的特征。
   
2. **RNN的问题：** 虽然RNN适用于序列特征提取，但递归运算的方式过于单一，可能难以有效提取股票数据中较为复杂的特征。

**选股因子挖掘网络： AlphaNet**

为了有效提取股票原始量价数据中的特征，AlphaNet借鉴了遗传规划中特征构建的思想，将多种运算符函数作为自定义网络层用于特征提取。AlphaNet包含四部分：

1. **数据输入：** 仿照CNN的方式，将个股原始量价数据整理为二维“数据图片”的形式输入网络。
   
2. **特征提取层：** AlphaNet中最关键的组成部分，实现了多种自定义运算网络层提取特征，并利用批标准化层进行特征标准化。
   
3. **池化层：** 与CNN中池化层基本一致，对上一层的特征进行“模糊化”操作。
   
4. **全连接层：** 对接预测目标，对提取的特征进行加权合成。

**结构：**

1. **数据输入：** AlphaNet仿照CNN的方式，将个股量价数据整理为“数据图片”的形式输入网络。每只股票在t-4到t的量价数据构成一张“数据图片”，对应的收益率R(t+m)作为标签。如果有3000只个股，就可以得到3000张个股的“数据图片”及其对应的标签。

2. **特征提取层：** 是AlphaNet最关键的组成部分，借鉴了遗传规划中特征构建的思想，将多种运算符函数作为自定义网络层进行特征提取。

3. **BN层：** 批标准化层在AlphaNet的特征标准化中起着重要作用。

4. **池化层：** 机制和CNN基本一致，对上一层的特征进行“模糊化”操作。包括ts_mean(X, d)、ts_max(X, d)和ts_min(X, d)等运算符的嵌套。

5. **全连接层：** 将特征提取层和池化层得到的特征进行展平后，接入全连接层，对接预测目标。整个网络的参数会根据预测目标的loss反向传播进行优化。

**数据准备：**

1. **股票池：** 全A股，剔除ST、PT股票，剔除每个截面期下一交易日涨跌停和停牌的股票。
   
2. **原始数据：** 未经过特征工程的个股量价信息，每只股票的量价数据拼接成9*30的“数据图片”，30为历史时间天数。

3. **预测目标：** 个股10天后标准化的收益率，个股5天后标准化的收益率。

4. **时间区间：** 2011年1月31日至2020年5月29日。

5. **样本内数据大小：** 每次训练使用过去1500个交易日的数据作为样本内数据，每隔两天采样一次。

6. **训练集和验证集比例：** 按照时间先后进行1:1划分，训练集在前，验证集在后。

**AlphaNet-v1训练和预测方式：**

1. **模型训练：** 从2011年1月31日开始，每隔半年进行滚动训练。样本内数据为过去1500个交易日的数据，训练集和验证集按照1:1划分。

2. **模型预测：** 在每个样本外数据截面上，使用最新训练的模型预测个股未来10天/5天的收益率。考虑神经网络的训练受随机数种子影响较大，重复以上步骤10次，得到10组预测结果，进行综合分析。

**组合构建和回测：**

对于AlphaNet-v1合成的因子，进行以下测试：

1. **单因子IC测试和分层测试：** 分析因子的RankIC均值、ICIR、分层组合年化收益率等指标。

2. **构建行业市值中性的中证500增强策略进行回测：** 分析策略的年化超额收益率、信息比率、超额收益最大回撤等指标。
